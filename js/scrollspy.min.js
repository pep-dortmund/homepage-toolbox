var toc = document.querySelector('.toc-sidebar');
var tocItems;

// percentage of window inner height
TOP_MARGIN = 0.1;
BOTTOM_MARGIN = 1;

window.addEventListener('resize', scrollspy, false);
window.addEventListener('scroll', isVisible, false);

scrollspy();

function scrollspy() {

  tocItems = [].slice.call(toc.querySelectorAll('li'));

  // Cache element references and measurements
  tocItems = tocItems.map(function(item) {
    var anchor = item.querySelector('a');
    var target = document.getElementById(anchor.getAttribute('href').slice(1));

    return {
      listItem: item,
      anchor: anchor,
      target: target
    };
  });

  // Remove missing targets
  tocItems = tocItems.filter(function(item) {
    return !!item.target;
  });

  isVisible();
}

function isVisible() {

  window.onscroll = function() {
    var scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;

    top_offset = TOP_MARGIN * window.innerHeight;
    bottom_offset = BOTTOM_MARGIN * window.innerHeight;

    tocItems.forEach(function(item, index) {

      var targetOffsetTop = item.target.offsetTop;
      var targetOffsetBottom = (tocItems.length - 1 == index) ? targetOffsetTop + window.innerHeight : tocItems[index + 1].target.offsetTop;

      if (targetOffsetTop < (scrollPosition + bottom_offset) && targetOffsetBottom > (scrollPosition + top_offset)) {
        item.listItem.classList.add('visible');
      }
      else {
        item.listItem.classList.remove('visible');
      }
    });
  };
}
